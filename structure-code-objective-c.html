<!DOCTYPE html>
<html lang="fr" itemscope itemtype="http://schema.org/Blog">
	<head>
		<meta charset="utf-8" />
		<title>Structurer un code Objective-C</title>
		
		<link rel="stylesheet" type="text/css" href="../style/main.css?quote"/>
		<link rel="stylesheet" type="text/css" href="../style/main-large.css" media="all and (min-device-width:800px)"/>
		
		<link rel="shortcut icon" href="../img/vt-16.png" />
		<link rel="apple-touch-icon-precomposed" href="../img/vt-114.png" />
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../img/vt-72.png" />
		
		<link href='http://fonts.googleapis.com/css?family=Nunito:300,700' rel='stylesheet' type='text/css'>
		<link href="feed.xml" type="application/atom+xml" rel="alternate" title="Blog (Atom)" />
		<meta name="viewport" content="width=device-width, user-scalable=no" />
		<meta itemprop="image" content="../img/vt-512.png">
		
		<!--[if lte IE 8]>
		<script src="../script/html5ie.js" type="text/javascript"></script>
		<![endif]-->
		
		<script type="text/javascript">
		  window.___gcfg = {lang: 'fr'};
		
		  (function() {
		    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
		    po.src = 'https://apis.google.com/js/plusone.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
		  })();
		</script>
		<script type="text/javascript">
		
		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-18279263-3']);
		  _gaq.push(['_trackPageview']);
		
		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
		
		</script>
	</head>
	<body class="post">
		<header>
			<h1>
				<a class="headline" href="../"><span>Vincent Tourraine</span></a>
				<span id="main"><a href="./"><span class="icon"><img src="../style/img/notepad-28-2x.png" alt="" /></span> <span>Blog</span></a></span>
			</h1>
		</header>
		<section class="post">
			<h1 itemprop="name">Structurer un code Objective-C</h1>
			<div class="meta"><time datetime="2014-10-25T09:43:16+02:00">25 October 2014</time>, <a class="tag" href="../blog/tags/code">#code</a> <a class="tag" href="../blog/tags/dev">#dev</a> <a class="tag" href="../blog/tags/objective-c">#objective-c</a> <a class="tag" href="../blog/tags/cocoa">#cocoa</a></div>
			<div itemprop="description" class="description">La qualité d’un code source est avant tout une question de structure. Lorsque je relis un code (notamment le mien), mon premier reproche concerne très souvent le manque de structure. Il n’existe pas de solution universelle, mais les bonnes pratiques en la matière permettent vraiment de développer plus efficacement, seul ou à plusieurs sur un projet. Voici donc un résumé des points qui me paraissent les plus importants pour bien structurer un code Objective-C.</div>
			<div class="content">
<h2>Le header</h2>

<p>Tout commence avec le fichier d’en-tête, <code>.h</code>, qui a la lourde tâche de présenter la classe. Avant toute chose, ce fichier ne doit contenir que le strict minimum, ni plus, ni moins. On doit y déclarer essentiellement deux types d’information : les propriétés et les méthodes.</p>

<p>Pour stocker les variables d’instance, il est vraiment préférable de n’utiliser que des propriétés <code>@property</code>, et de laisser tomber les <code>ivar</code>. N’hésitez-pas à déclarer en lecture seule (<code>readonly</code>) toutes celles qui le permettent, et préférez les types immuables autant que possible (par exemple <code>NSArray</code> plutôt que <code>NSMutableArray</code>). Ces paramètres favorisent un code plus précis, et donc plus efficace. </p>

<p>Du côté des méthodes, on trouve généralement un initialiseur, qui permet d’indiquer au développeur comment bien instancier un objet. On peut en profiter pour passer des propriétés en lecture seule déclarées juste avant, pour des variables de configuration par exemple. Pour économiser des <code>alloc/init</code> et faciliter la création d’instances, on peut aussi proposer des constructeurs similaires à <code>[NSString stringWithFormat:]</code> ou <code>[NSArray array]</code>. On aura sûrement besoin d’autres méthodes, notamment les “actions” pour un view controller, qui seront reliées aux différents éléments d’interface.</p>

<p>Voici un exemple de ce que cela peut donner concrètement :</p>

<pre><code>@import UIKit;

@interface MyController : UIViewController

@property (nonatomic, strong, readonly) Context *context;

@property (nonatomic, weak) IBOutlet UITextField *nameTextField;
@property (nonatomic, weak) IBOutlet UIButton *createButton;

- (instancetype)initWithContext:(Context *)context;
+ (instancetype)controllerWithContext:(Context *)context;

- (IBAction)createStuff:(id)sender;

@end
</code></pre>

<p>On peut aussi garder à l’esprit que tout ce qui apparaît dans l’en-tête doit être testable (mieux : testé). Les comportements observables de l’object doivent être conformes aux attentes, et les tests unitaires sont là pour s’en assurer. On dit parfois que le header est une sorte de contrat passé entre l’auteur du code et tout ce qui interagit avec cette classe. Tout le monde se porte mieux si ce contrat reste court, précis et clair.</p>

<h2>Le header privé</h2>

<p>Il existe une technique très utile permettant d’utiliser un en-tête privé pour toutes les déclarations qui doivent rester cachées. Encore une fois, il s’agit de limiter autant que possible les déclarations publiques. Mais comment faire alors pour déclarer tout ce dont on a besoin pour faire fonctionner la classe ? En haut de votre fichier d’implémentation, <code>.m</code>, déclarez une catégorie anonyme sur votre classe. Vous pouvez alors y inclure de nouvelles propriétés et de nouvelles méthodes qui resteront invisibles de l’extérieur. </p>

<pre><code>@interface MyController ()

@property (nonatomic, strong, readwrite) Context *context;

- (NSString *)generateRandomName;

@end
</code></pre>

<p>Comme le montre cet exemple, vous pouvez même en profiter pour re-déclarer une propriété, publiquement en lecture-seule, pour l’utiliser en privé en lecture-écriture. Il s’agira bien de la même variable, mais vous en simplifiez l’utilisation en la limitant à la lecture pour un code externe.</p>

<h2>Découper avec #pragma mark</h2>

<p>Dans n’importe quel texte et pour n’importe quel domaine, vous trouvez des sections pour structurer un ensemble. Dans le cas d’une classe Objective-C, il existe une instruction qui remplit bien ce rôle : le <code>#pragma mark</code>. Comme tout ce qui est précédé par un “#”, il s’agit d’une instruction pour le pré-processeur C, qui est donc traitée avant la compilation du code. Dans ce cas précis, c’est une simple décoration, qui n’a donc aucun impact sur le reste du code ou même sur la compilation elle-même. En revanche, cette instruction est notamment reconnue par Xcode, qui l’interprète comme une marque de mise en forme pour le navigateur de code. En bonus, les tirets “-” sont traités comme des barres horizontales de séparation. </p>

<div class="slideshow">
  <img src="img/structure-code-objective-c/xcode-navigation.png" class="nostyle" alt="Xcode navigation" />
</div>

<p>On peut tout de même noter pour les plus curieux que Clang (le compilateur utilisé par Xcode) utilise dans certains cas #pragma pour configurer localement des paramètres, comme indiqué dans <a href="http://clang.llvm.org/docs/UsersManual.html#controlling-diagnostics-via-pragmas">sa documentation</a>.</p>

<p>Mes view controllers commencent généralement par une section “view lifecycle” qui contient le <code>init</code>, le <code>viewDidLoad</code>, et les <code>viewDid/Will/Appear/Disappear</code>. Ensuite, une section “configuration” regroupe les méthodes de mise en place des vues et de coordination avec le modèle. Viennent ensuite les “actions”, qui pourront être invoquées avec les différents boutons ou événements attachés au controller. Enfin, j’organise classiquement une section par protocole implémenté par la classe. Pour un <code>UITableViewController</code>, on y retrouve bien sûr le <code>UITableViewDelegate</code> et <code>UITableDataSource</code>, mais il en existe bien d’autres, pour répondre à un <code>UIAlertView</code> ou un <code>MFMailComposeViewController</code> par exemple.</p>

<h2>Découpage</h2>

<p>La longueur du code n’est pas un problème en soi, a fortiori avec Objective-C et Cocoa qui assument fièrement leur caractère verbeux, mais elle peut souvent être symptomatique d’un certain manque d’organisation. De mon point de vue, quand un view controller dépasse les 1000 lignes de code, il faut commencer à songer à en séparer certains aspects. Pour un modèle ou une vue, le seuil est plutôt vers 100 LoC. C’est aussi dans cette situation que l’organisation en <code>#pragma</code> se révèle utile, puisqu’on devrait pouvoir découper la plupart des sections vers des classes dédiées. </p>

<p>Ce re-découpage nécessite parfois d’exposer davantage de propriétés ou de méthodes afin de conserver le même fonctionnement réparti sur plusieurs objects. Encore une fois, il convient de limiter les portes d’entrée de vos classes, mais un fichier trop volumineux est également problématique à terme. Il s’agit donc de trouver un équilibre satisfaisant, pour faire le tri entre ce qui constitue une interface et ce qui tient du détail d’implémentation.</p>

<p>Comme c’est parfois le cas avec Cocoa, il peut être intéressant de regrouper certaines parties d’une classe à l’intérieur d’une catégorie. C’est particulièrement approprié quand un ensemble de méthodes apporte une nouvelle dépendance, par exemple lorsque NSString se base sur UIKit pour dessiner une chaîne de caractères. </p>

<p>Cette technique a ses avantages et ses inconvénients. On peut facilement y mettre des méthodes de configuration, qui vont globalement agir sur des propriétés déjà déclarées, ou générer un résultat à partir de certains paramètres. Par contre, on ne peut pas utiliser une catégorie pour déclarer de nouvelles propriétés, et ses méthodes ne pourront pas être surchargées par une sous-classe (certes, il existe des techniques pour contourner ces limitations, mais ça ne me paraît vraiment pas correspondre à une bonne pratique). </p>

<h2>Conclusion</h2>

<p>Autant de pistes différentes et souvent complémentaires pour structurer un code source, et garantir un bon niveau de qualité. Pour les autres, mais avant tout pour soi.</p>

<p>Évidemment, ce ne sont que mes modestes recommandations. Si vous avez d’autres suggestions, ou mieux, si vous avez des contre-arguments concernant les points évoqués, les commentaires sont là pour ça. </p>


</div>
			<div class="share">
				<a href="https://twitter.com/share" class="twitter-share-button" data-text="&quot;Structurer un code Objective-C&quot; par @vtourraine" data-count="horizontal" data-lang="fr">Tweet</a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
				<div class="g-plusone" data-size="medium" ></div>	
				<a href="https://plus.google.com/u/0/117326560329576507699/posts" class="profile" rel="author me">Google+</a>
			</div>
			<div class="comments">
				<div id="disqus_thread"></div>
				<script type="text/javascript">
				    var disqus_shortname = 'vtourraine';
				
				    (function() {
				        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
				        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
				    })();
				</script>
				<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
				<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
			</div>
		</section>
		
		<section>
			<div>
				<div class="postprevious">
					<a href="http://www.vtourraine.net/blog/mixit-futur-interfaces-science-fiction"><span>← Billet précédent</span><br/>Le futur des Interfaces dans la Science-Fiction</a>
				</div>
				<div class="postnext">
					<a href="http://www.vtourraine.net/blog/selection-magazines"><span>Billet suivant →</span><br />Ma sélection de magazines</a>
				</div>
			</div>
		</section>
		<footer>
			<nav>
				<a href="../">Vincent Tourraine</a> / <a href="../projects/">Projets</a> / <a href="./"><span>Blog</span></a>
			</nav>
			<div id="mail">
				<a href="mailto:me@vtourraine.net">me@vtourraine.net</a>
			</div>
		</footer>
	</body>
</html>